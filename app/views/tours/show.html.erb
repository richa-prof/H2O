<% @title = @tour.tour_locales&.first&.metatag_titulo %>
<% content_for :meta_description, @tour.tour_locales&.first&.metatag_descricao %>
<%= render 'schema_org_show' %>

<section class="product-header">
  <div class="container">
    <div class="row">
      <div class="col-auto">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="/"><%= t 'home' %></a></li>
          <li class="breadcrumb-item"><a href="<%= tours_path %>"><%= t 'activerecord.models.tour.other' %></a></li>
          <li class="breadcrumb-item active"><%= @title %></li>
        </ol>
      </div>
    </div>
  </div>
</section>

<%= render 'images' %>

<section class="product-detail">
  <div class="container">
    <div class="row">
      <div class="col-<%= @tour.ta_location.blank? ? '12' : '10' %> total-center">
        <h1><%= @tour.tour_locales&.first&.nome %></h1>
      </div>
      <% unless @tour.ta_location.blank? %>
        <div class="col-2 total-center">
            <div id="TA_cdsratingsonlynarrow791" class="TA_cdsratingsonlynarrow">
              <ul id="iyuRVZr65vDT" class="TA_links 7KxSJIXjY">
                <li id="1CBynVB" class="pCniB1AS">
                  <a target="_blank" href="http://www.tripadvisor.com/">
                      <img src="http://www.tripadvisor.com/img/cdsi/img2/branding/tripadvisor_logo_transp_340x80-18034-2.png" alt="TripAdvisor" />
                  </a>
                </li>
              </ul>
            </div>
          <script src="https://www.jscache.com/wejs?wtype=cdsratingsonlynarrow&amp;uniq=791&amp;locationId=<%= @tour.ta_location %>&amp;lang=<%= params[:locale] == 'en-US' ? 'en_US' : 'pt_BR' %>&amp;border=true">
          </script>
        </div>
      <% end %>

      <div class="col-12">
        <div class="trip-box">
          <div class="row mb-5">
            <div class="col-12 text-center">
              <h2 class="mb-2">Compre online!</h2>
              <%= image_tag 'tour-steps.png', alt: 'Compra Online H2O', title: 'Compre passeios online com a agÃªncia H2O', width: '50%' %>
            </div>
          </div>

          <div class="row">
            <div class="col-12 col-lg-3">
              <div class="form-group">
                <label for="selected_date"><%=t 'tour_date' %></label>
                <%= form_tag availability_and_price_tour_path(@tour), method: :get, remote: true, id: 'selected_date_frm' do %>
                  <%= text_field_tag :selected_date, @selected_date.strftime('%d/%m/%Y'), placeholder: 'Selecione a data', class: 'form-control text-center datepicker' %>
                  <span class="icon datepicker_icon" style="cursor: pointer"><i class="far fa-calendar-alt"></i></span>
                <% end %>
              </div>
            </div>

            <div class="col-12 col-lg-9">
              <div id="tour_availability" class="text-center">
                <%= render 'tour_availability' %>
              </div>
            </div>

            <div class="col-12">
              <div id="tour_price">
                <%= render 'tour_price' %>
              </div>
            </div>

            <div class="col-12">
              <div id="tour_persons" class="row tour_persons">
                <%= render 'tour_persons' if @tour_price %>
              </div>
            </div>

            <div class="col-12">
              <div id="tour_extras" class="row tour_persons">
                <%= render 'tour_extras' if @tour_extras %>
              </div>
            </div>

            <div class="col-12 text-right">
              <div class="availability-box">
                <div id="add_to_trip_box"><%= render 'add_to_trip_box' %></div>
                <a id="add_to_trip_btn" class="btn btn-primary btn-md pointer hide"><%= t 'buy_now' %></a>
              </div>
            </div>

          </div>
        </div>
      </div>

      <%= render 'details' %>

    </div>
  </div>
</section>

<%= render 'related_tours' %>

<script>
$(document).ready(function() {
  update_tour_availability();
});

$("#add_to_trip_btn, #tour_persons, #tour_extras").hide();

$('#selected_date').on('changeDate', function (ev) {
  update_tour_availability();
});
$(".datepicker_icon").click(function() {
  $("#selected_date").datepicker( "show" );
});
$(document).on('click', '.tour_time', function (event) {
  $(".tour_time").removeClass('active');
  $(this).addClass('active');
  $("#tour_persons, #tour_extras").show();
  set_total_price();
  $("#add_to_trip_btn").show();
  $('.main-input-number').attr('max', $(this).find('span').html());
  $(".btn-number[data-type='plus']").removeAttr('disabled');
  $(".btn-number[data-type='minus']").attr('disabled', true);
});
$("#add_to_trip_btn").click(function() {
  var total = 0;
  $(".main-input-number").each(function() {
    total += +($(this).val());
  });
  if(total > 0){
    $(".extra-input-number").each(function() {
      $("#tour_extra_"+$(this).attr('data-type')+"_"+$(this).attr('data-id')).val($(this).val());
    });
    $("#tour_selected_date").val($("#selected_date").val());
    $("#tour_selected_time").val($(".tour_time.active").attr('value'));
    $("#tour_system").val($(".tour_time.active").attr('system'));
    $("#tour_adults").val($("#adults").val());
    $("#tour_children").val($("#children").val());
    $("#tour_children2").val($("#children2").val());
    $("#cart-form").submit();
  } else {
    alert("Acrescente pessoas");
  }
});
function update_tour_availability() {
  $(".tour_time").removeClass('active');
  $(".tour_time, #add_to_trip_btn").hide();
  $("#tour_price, #tour_persons, #tour_extras").html('');
  $("#tour_availability_loading").show();
  $('form#selected_date_frm').submit();
}
function assign_input_number_btn_functions() {
  $('.btn-number').click(function(e){
    e.preventDefault();
    fieldName = $(this).attr('data-field');
    type      = $(this).attr('data-type');
    var input = $("input[name='"+fieldName+"']");
    var currentVal = parseInt(input.val());
    if (!isNaN(currentVal)) {
      if(type == 'minus') {
        if(currentVal > input.attr('min')) {
          input.val(currentVal - 1).change();
          set_total_price();
        }
        if(parseInt(input.val()) == input.attr('min')) {
          $(this).attr('disabled', true);
        }
      } else if(type == 'plus') {
        if(currentVal < input.attr('max')) {
          input.val(currentVal + 1).change();
          set_total_price();
        }
        if(parseInt(input.val()) == input.attr('max')) {
          $(this).attr('disabled', true);
        }
      }
    } else {
      input.val(0);
    }
    var total = 0;
    $(".main-input-number").each(function() {
      total += +($(this).val());
    });
    if(total == input.attr('max')){
      $(".main-btn-number[data-type='plus']").attr('disabled', true);
    } else {
      $(".main-btn-number[data-type='plus']").removeAttr('disabled');
    }
  });
  $('.input-number').focusin(function() {
    $(this).data('oldValue', $(this).val());
  });
  $('.input-number').change(function() {
    minValue =  parseInt($(this).attr('min'));
    maxValue =  parseInt($(this).attr('max'));
    valueCurrent = parseInt($(this).val());
    name = $(this).attr('name');
    if(valueCurrent >= minValue) {
      $(".btn-number[data-type='minus'][data-field='"+name+"']").removeAttr('disabled')
    } else {
      alert('Sorry, the minimum value was reached');
      $(this).val($(this).data('oldValue'));
    }
    if(valueCurrent <= maxValue) {
      $(".btn-number[data-type='plus'][data-field='"+name+"']").removeAttr('disabled')
    } else {
      alert('Sorry, the maximum value was reached');
      $(this).val($(this).data('oldValue'));
    }
  });
  $(".input-number").keydown(function (e) {
    if ($.inArray(e.keyCode, [46, 8, 9, 27, 13, 190]) !== -1 ||
    (e.keyCode == 65 && e.ctrlKey === true) ||
    (e.keyCode >= 35 && e.keyCode <= 39)) {
      return;
    }
    if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) {
      e.preventDefault();
    }
  });
}
function set_total_price() {
	var sum = 0;
  $(".input-number").each(function() {
		sum += +($(this).val() * $(this).attr('data-value'));
  });
  $("#price").html(to_brl(sum));
  $("#tour_final_price").val(sum);
  if(sum > 0){
    $("#add_to_trip_btn").show();
  } else {
    $("#add_to_trip_btn").hide();
  }
}
assign_input_number_btn_functions();
</script>
